<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seoul Trip 2025 (Local Checklist)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream-bg': '#FDFBF7',
                        'cream-card': '#FFFDF9',
                        'soft-brown': '#8D7B68',
                        'accent-beige': '#F3E9D2',
                        'highlight': '#C8B6A6',
                        'alert-red': '#E07A5F'
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'Nunito', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
            background-color: #FDFBF7;
            user-select: none; 
            -webkit-user-select: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        .header-container {
            height: 250px;
            width: 100%;
            position: relative;
            background-color: #ddd; 
            overflow: hidden;
        }
        .header-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        .main-content {
            margin-top: -30px; 
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            background-color: #FDFBF7;
            position: relative;
            z-index: 10;
            min-height: calc(100vh - 220px);
            padding-bottom: 100px; /* 增加底部空間以免被 Tab 擋住 */
        }
        .nav-tabs {
            position: absolute;
            bottom: 40px; 
            right: 20px;
            display: flex;
            gap: 8px; /* 縮小間距以容納更多 Tab */
            z-index: 20;
            max-width: 95vw;
            overflow-x: auto;
        }
        .tab-btn {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
            border-radius: 16px;
            padding: 8px 12px;
            color: #8D7B68;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.5);
            white-space: nowrap;
        }
        .tab-btn.active {
            background: #8D7B68;
            color: #fff;
            transform: translateY(-2px);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 拖曳時的樣式 */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #F3E9D2;
        }
        .sortable-drag {
            cursor: grabbing;
        }
        
        /* Checkbox Custom Style */
        .custom-checkbox input:checked + div {
            background-color: #8D7B68;
            border-color: #8D7B68;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-soft-brown antialiased selection:bg-accent-beige">

    <div id="app">
        <!-- 頁首區域 (固定圖片) -->
        <header class="header-container">
            <img src="./image.PNG" 
                 class="header-image" 
                 alt="Header Banner"
                 onerror="this.style.display='none';">
            
            <div class="absolute top-8 left-6 text-white drop-shadow-md">
                <h1 class="text-3xl font-bold tracking-wider">Seoul Trip</h1>
                <p class="text-sm opacity-90 tracking-widest">2025.12.27 - 2026.01.02</p>
            </div>

            <div class="nav-tabs no-scrollbar">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click.stop="currentTab = tab.id"
                    class="tab-btn"
                    :class="{ 'active': currentTab === tab.id }"
                >
                    <i :class="tab.icon" class="text-lg"></i>
                    <span v-if="currentTab === tab.id">{{ tab.name }}</span>
                </button>
            </div>
        </header>

        <!-- 主內容區域 -->
        <main class="main-content px-5 pt-8">
            
            <!-- 1. 行程表 -->
            <div v-if="currentTab === 'schedule'" class="space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-bold">每日行程</h2>
                    <span class="text-xs text-gray-400">長按行程卡片可拖曳排序</span>
                </div>

                <div class="flex overflow-x-auto gap-3 pb-2 mb-2 no-scrollbar -mx-5 px-5">
                    <button 
                        v-for="(day, index) in data.itinerary" 
                        :key="index"
                        @click="currentDayIndex = index"
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all shadow-sm border"
                        :class="currentDayIndex === index ? 'bg-soft-brown text-white border-soft-brown' : 'bg-white text-gray-400 border-gray-100'"
                    >
                        Day {{ index + 1 }}
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-100 min-h-[400px] relative transition-all">
                    <div class="flex items-center justify-between mb-5 border-b border-dashed border-stone-200 pb-3">
                        <div>
                            <h3 class="text-xl font-bold text-soft-brown">Day {{ currentDayIndex + 1 }}</h3>
                            <span class="text-sm text-gray-400 font-medium">{{ currentDayData.date }}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <button @click="cycleWeather(currentDayIndex)" class="flex flex-col items-center bg-blue-50 px-3 py-1 rounded-lg hover:bg-blue-100 transition min-w-[60px]">
                                <i :class="getWeatherIcon(currentDayData.weather)" class="text-2xl text-blue-500 mb-1"></i>
                                <span class="text-[10px] text-blue-400 font-bold">{{ getWeatherName(currentDayData.weather) }}</span>
                            </button>
                            <span v-if="currentDayData.temp" class="text-xs font-bold text-gray-400 mt-1 tracking-wider">{{ currentDayData.temp }}</span>
                        </div>
                    </div>
                    
                    <div v-if="currentDayData.events.length > 0" class="relative pl-2">
                        <!-- 時間軸線 (獨立於拖曳區塊外) -->
                        <div class="absolute left-[9px] top-2 bottom-4 w-[2px] bg-accent-beige rounded-full z-0"></div>

                        <!-- 拖曳容器：ref="eventListRef" -->
                        <div ref="eventListRef" class="space-y-6 relative z-10">
                            <div v-for="(item, i) in currentDayData.events" :key="item.title + i" class="flex gap-4 relative group cursor-grab active:cursor-grabbing">
                                <div class="z-10 mt-1 relative">
                                    <div class="w-4 h-4 rounded-full bg-cream-bg border-4 border-soft-brown"></div>
                                </div>
                                
                                <div class="flex-1 bg-gray-50 rounded-xl p-3 border border-transparent hover:border-accent-beige transition-colors relative select-none">
                                    <div class="flex justify-between items-start mb-1">
                                        <h4 class="font-bold text-soft-brown text-lg">{{ item.title }}</h4>
                                        <!-- 編輯按鈕：阻止冒泡以免觸發拖曳 -->
                                        <button @click.stop="openEditModal(i)" @mousedown.stop @touchstart.stop class="text-gray-300 hover:text-soft-brown p-1">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </button>
                                    </div>
                                    
                                    <span v-if="item.time" class="inline-block text-xs font-bold text-white bg-highlight px-2 py-0.5 rounded mb-2">
                                        {{ item.time }}
                                    </span>

                                    <div v-if="item.image" 
                                         @click.stop="openZoomModal(item.image)"
                                         @mousedown.stop @touchstart.stop
                                         class="mb-3 rounded-lg overflow-hidden w-full max-h-48 border border-gray-100 shadow-sm relative group">
                                        <img :src="item.image" class="w-full h-full object-cover" alt="Event Image">
                                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                                            <i class="ph-bold ph-magnifying-glass-plus text-white opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-md text-2xl"></i>
                                        </div>
                                    </div>

                                    <p v-if="item.desc" class="text-sm text-gray-500 whitespace-pre-line leading-relaxed mb-2">{{ item.desc }}</p>
                                    
                                    <div v-if="item.note" class="bg-red-50 p-2 rounded-lg border border-red-100 mb-2">
                                        <p class="text-xs text-alert-red font-bold flex items-center gap-1">
                                            <i class="ph-fill ph-star"></i> {{ item.note }}
                                        </p>
                                    </div>

                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <!-- 修改地點連結邏輯：優先使用 mapUrl，若無則回退到 Naver 搜尋 -->
                                        <a v-if="item.location" :href="item.mapUrl || getNaverLink(item.location)" target="_blank" @mousedown.stop @touchstart.stop class="inline-flex items-center gap-1 text-xs text-green-600 font-bold hover:underline bg-green-50 px-2 py-1.5 rounded-lg border border-green-100 transition-colors hover:bg-green-100">
                                            <i class="ph-fill ph-map-pin"></i> {{ item.location }}
                                        </a>
                                        <a v-if="item.link" :href="item.link" target="_blank" @mousedown.stop @touchstart.stop class="inline-flex items-center gap-1 text-xs text-blue-600 font-bold hover:underline bg-blue-50 px-2 py-1.5 rounded-lg border border-blue-100 transition-colors hover:bg-blue-100">
                                            <i class="ph-bold ph-link"></i> 開啟連結
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center py-10 text-gray-300">
                        <i class="ph ph-coffee text-4xl mb-2 block"></i>
                        <p>今天還沒有安排行程喔</p>
                    </div>

                    <button @click="openAddModal" class="w-full mt-6 py-3 border-2 border-dashed border-accent-beige rounded-xl text-soft-brown font-bold hover:bg-accent-beige hover:border-solid transition-colors flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus"></i> 新增行程
                    </button>
                </div>
            </div>

            <!-- 5. 行前準備 (Checklist) - LOCAL STORAGE -->
            <div v-if="currentTab === 'checklist'" class="space-y-6">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="text-2xl font-bold">行前準備</h2>
                        <span class="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded ml-1">個人清單 (不共用)</span>
                    </div>
                    <p class="text-xs text-gray-400">打包進度: {{ progressText }}</p>
                </div>

                <!-- 進度條 -->
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div class="bg-soft-brown h-2.5 rounded-full transition-all duration-500 ease-out" :style="{ width: progressPercentage + '%' }"></div>
                </div>

                <!-- 新增物品輸入框 -->
                <div class="flex gap-2 mb-6">
                    <input v-model="newChecklistItem" @keyup.enter="addChecklistItem" type="text" placeholder="還有什麼要帶的？(僅存在此裝置)" class="flex-1 bg-white border border-stone-200 rounded-xl px-4 py-3 focus:outline-none focus:border-soft-brown shadow-sm text-sm">
                    <button @click="addChecklistItem" class="bg-soft-brown text-white rounded-xl px-4 font-bold shadow-md hover:bg-stone-600">
                        <i class="ph-bold ph-plus"></i>
                    </button>
                </div>

                <!-- 分類顯示 -->
                <div v-for="(items, category) in categorizedChecklist" :key="category" class="bg-white rounded-2xl p-5 shadow-sm border border-stone-100">
                    <h3 class="font-bold text-soft-brown text-lg mb-4 flex items-center gap-2 pb-2 border-b border-dashed border-gray-100">
                        <i class="ph-fill ph-tag text-highlight"></i> {{ category }}
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                        <div v-for="item in items" :key="item.id" class="flex items-center group">
                            <label class="custom-checkbox flex items-center cursor-pointer w-full">
                                <input type="checkbox" class="hidden" :checked="item.checked" @change="toggleChecklistItem(item)">
                                <div class="w-5 h-5 border-2 border-stone-300 rounded flex items-center justify-center mr-3 transition-colors bg-white shrink-0 group-hover:border-soft-brown">
                                    <svg class="w-3 h-3 text-white hidden fill-current" viewBox="0 0 20 20"><path d="M0 11l2-2 5 5L18 3l2 2L7 18z"/></svg>
                                </div>
                                <div class="flex-1 flex justify-between items-center min-w-0">
                                    <span class="text-sm text-gray-700 truncate select-none" :class="{'line-through text-gray-400 opacity-70': item.checked}">
                                        {{ item.text }}
                                    </span>
                                    <button v-if="item.isCustom" @click.prevent.stop="deleteChecklistItem(item)" class="text-gray-200 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i class="ph-fill ph-trash"></i>
                                    </button>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 資訊 -->
            <div v-if="currentTab === 'info'" class="space-y-5">
                <h2 class="text-2xl font-bold mb-4">旅程資訊</h2>
                <div class="bg-amber-50 rounded-2xl p-5 border border-amber-100">
                    <h3 class="font-bold text-amber-800 flex items-center gap-2 mb-3">
                        <i class="ph-fill ph-warning-circle"></i> 重要提醒
                    </h3>
                    <ul class="text-sm text-amber-900 space-y-2 list-disc list-inside mb-4">
                        <li><strong>電子入境表單 (K-ETA/Q-Code)：</strong><br>需在出發前 72 小時填寫。</li>
                        <li><strong>準備護照</strong>：確保有效期。</li>
                    </ul>
                    <a href="https://e-arrivalcard.go.kr/portal/main/index.do" target="_blank" class="w-full bg-amber-200 text-amber-900 font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-amber-300 transition shadow-sm">
                        <i class="ph-bold ph-pencil-simple-line"></i> 
                        填寫電子入境卡 (Q-Code)
                    </a>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-100">
                    <h3 class="font-bold text-soft-brown flex items-center gap-2 mb-3">
                        <i class="ph-fill ph-airplane-tilt text-blue-400"></i> 航班資訊
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                            <div class="text-center">
                                <div class="text-xl font-bold">TSA</div>
                                <div class="text-xs text-gray-400">松山</div>
                                <div class="text-sm font-bold mt-1">09:20</div>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-2">
                                <span class="text-xs font-bold text-soft-brown">BR156 (12/27)</span>
                                <div class="h-[1px] w-full bg-gray-300 my-1 relative">
                                    <i class="ph-fill ph-airplane absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-300 bg-gray-50 p-1"></i>
                                </div>
                                <span class="text-xs text-gray-400">去程</span>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold">GMP</div>
                                <div class="text-xs text-gray-400">金浦</div>
                                <div class="text-sm font-bold mt-1">12:50</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                            <div class="text-center">
                                <div class="text-xl font-bold">GMP</div>
                                <div class="text-xs text-gray-400">金浦</div>
                                <div class="text-sm font-bold mt-1">13:50</div>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-2">
                                <span class="text-xs font-bold text-soft-brown">BR155 (01/02)</span>
                                <div class="h-[1px] w-full bg-gray-300 my-1 relative">
                                    <i class="ph-fill ph-airplane absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-300 bg-gray-50 p-1 rotate-180"></i>
                                </div>
                                <span class="text-xs text-gray-400">回程</span>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold">TSA</div>
                                <div class="text-xs text-gray-400">松山</div>
                                <div class="text-sm font-bold mt-1">15:35</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-100">
                    <h3 class="font-bold text-soft-brown flex items-center gap-2 mb-3">
                        <i class="ph-fill ph-house-line text-green-500"></i> 住宿資料
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="pb-4 border-b border-dashed border-gray-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold text-lg block">Wecostay Namsam</span>
                                    <p class="text-xs text-gray-400 mt-0.5">Check-in: 16:00 / Out: 11:00</p>
                                </div>
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded h-fit font-bold text-gray-600">12/27 - 12/31</span>
                            </div>
                            
                            <div class="bg-gray-50 p-3 mt-3 rounded-lg cursor-pointer active:bg-gray-100 relative group" @click="copyText('04554 중구 필동1가 43-1')">
                                <p class="text-sm text-gray-600">04554 중구 필동1가 43-1</p>
                                <p class="text-xs text-gray-400 mt-1 flex items-center gap-1"><i class="ph-bold ph-copy"></i> 點擊複製韓文地址</p>
                            </div>

                            <div class="bg-gray-50 p-3 mt-2 rounded-lg cursor-pointer active:bg-gray-100 relative group" @click="copyText('+82 70-4138-3576')">
                                <div class="flex items-center gap-2">
                                    <i class="ph-fill ph-phone text-soft-brown"></i>
                                    <span class="text-sm text-gray-600 font-bold">+82 70-4138-3576</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1 pl-6 flex items-center gap-1"><i class="ph-bold ph-copy"></i> 點擊複製電話</p>
                            </div>

                            <a :href="getNaverLink('04554 중구 필동1가 43-1')" target="_blank" class="w-full mt-3 bg-green-50 text-green-600 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition">
                                <i class="ph-fill ph-map-trifold"></i> 開啟 Naver Map
                            </a>
                        </div>

                        <div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold text-lg block">Airbnb</span>
                                    <p class="text-xs text-gray-400 mt-0.5">Check-in: 15:00 / Out: 11:00</p>
                                </div>
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded h-fit font-bold text-gray-600">01/01 - 01/02</span>
                            </div>

                            <div class="bg-gray-50 p-3 mt-3 rounded-lg cursor-pointer active:bg-gray-100 relative group" @click="copyText('首尔特别市 广津区 紫阳洞 5-53')">
                                <p class="text-sm text-gray-600">首尔特别市 广津区 紫阳洞 5-53</p>
                                <p class="text-xs text-gray-400 mt-1 flex items-center gap-1"><i class="ph-bold ph-copy"></i> 點擊複製中文地址</p>
                            </div>

                            <a :href="getNaverLink('首尔特别市 广津区 紫阳洞 5-53')" target="_blank" class="w-full mt-3 bg-green-50 text-green-600 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition">
                                <i class="ph-fill ph-map-trifold"></i> 開啟 Naver Map
                            </a>
                        </div>
                    </div>
                </div>
                 <a href="https://www.accuweather.com/zh/kr/seoul/226081/december-weather/226081" target="_blank" class="block bg-blue-50 rounded-2xl p-4 text-center text-blue-600 font-bold hover:bg-blue-100 transition">
                    <i class="ph-fill ph-cloud-sun"></i> 查看首爾天氣預報
                 </a>
            </div>

            <!-- 3. 購物清單 -->
            <div v-if="currentTab === 'shopping'" class="space-y-4">
                <h2 class="text-2xl font-bold mb-2">購物清單</h2>
                
                <div class="bg-gray-100 p-1 rounded-xl flex gap-1 mb-2">
                    <button 
                        @click="currentShopper = 'Wawa'"
                        class="flex-1 py-2 rounded-lg text-sm font-bold transition-all duration-200"
                        :class="currentShopper === 'Wawa' ? 'bg-white text-soft-brown shadow-sm' : 'text-gray-400 hover:text-gray-600'"
                    >
                        <i class="ph-bold ph-smiley"></i> Wawa
                    </button>
                    <button 
                        @click="currentShopper = 'Cherisa'"
                        class="flex-1 py-2 rounded-lg text-sm font-bold transition-all duration-200"
                        :class="currentShopper === 'Cherisa' ? 'bg-white text-soft-brown shadow-sm' : 'text-gray-400 hover:text-gray-600'"
                    >
                        <i class="ph-bold ph-smiley-wink"></i> Cherisa
                    </button>
                </div>

                <div class="flex gap-2">
                    <input v-model="newItem" @keyup.enter="addItem" type="text" :placeholder="`想幫 ${currentShopper} 買什麼？`" class="flex-1 bg-white border border-stone-200 rounded-xl px-4 py-3 focus:outline-none focus:border-soft-brown shadow-sm text-sm">
                    <button @click="addItem" class="bg-soft-brown text-white rounded-xl px-4 font-bold shadow-md hover:bg-stone-600">
                        <i class="ph-bold ph-plus"></i>
                    </button>
                </div>

                <div class="space-y-2 mt-4">
                    <div v-if="filteredShoppingList.length === 0" class="text-center text-gray-300 py-10">
                        <i class="ph ph-bag text-4xl mb-2 block"></i>
                        {{ currentShopper }} 的清單是空的喔
                    </div>
                    
                    <div v-for="(item) in filteredShoppingList" :key="item.id" 
                         class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex items-center justify-between group transition-all"
                         :class="{'opacity-50': item.done}">
                        <div class="flex items-center gap-3">
                            <button @click="toggleItemDone(item)" 
                                    class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                                    :class="item.done ? 'bg-green-500 border-green-500' : 'border-stone-300'">
                                <i v-if="item.done" class="ph-bold ph-check text-white text-xs"></i>
                            </button>
                            <span :class="{'line-through text-gray-400': item.done}">{{ item.text }}</span>
                        </div>
                        <button @click="deleteItem(item)" class="text-gray-300 hover:text-red-400">
                            <i class="ph-fill ph-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 4. 花費 -->
            <div v-if="currentTab === 'money'" class="space-y-5">
                <h2 class="text-2xl font-bold mb-4">旅費記帳</h2>
                
                <div class="bg-soft-brown text-white rounded-2xl p-5 shadow-lg relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-24 h-24 bg-white opacity-10 rounded-full"></div>
                    
                    <div class="flex justify-between items-end border-b border-white/20 pb-4 mb-4">
                        <div>
                            <p class="text-xs opacity-80">總支出 (KRW)</p>
                            <h3 class="text-2xl font-bold mt-1">₩ {{ totalKRW.toLocaleString() }}</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-xs opacity-80">總支出 (TWD)</p>
                            <h3 class="text-2xl font-bold mt-1">NT$ {{ totalTWD.toLocaleString() }}</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-xs mb-4">
                        <div class="space-y-1">
                            <span class="font-bold opacity-90 block border-b border-white/10 pb-1 mb-1">Wawa 代墊</span>
                            <div class="flex justify-between"><span class="opacity-70">KRW</span> <span>{{ wawaPaidKRW.toLocaleString() }}</span></div>
                            <div class="flex justify-between"><span class="opacity-70">TWD</span> <span>{{ wawaPaidTWD.toLocaleString() }}</span></div>
                        </div>
                        <div class="space-y-1 text-right">
                            <span class="font-bold opacity-90 block border-b border-white/10 pb-1 mb-1">Cherisa 代墊</span>
                            <div class="flex justify-between justify-end gap-2"><span class="opacity-70">KRW</span> <span>{{ cherisaPaidKRW.toLocaleString() }}</span></div>
                            <div class="flex justify-between justify-end gap-2"><span class="opacity-70">TWD</span> <span>{{ cherisaPaidTWD.toLocaleString() }}</span></div>
                        </div>
                    </div>

                    <div class="bg-white/10 rounded-xl p-3 text-center backdrop-blur-sm">
                        <p class="text-[10px] opacity-70 mb-2">分帳建議 (各付各的一半)</p>
                        <div class="space-y-1">
                            <p class="font-bold text-sm text-accent-beige" v-if="settlementKRWText">
                                {{ settlementKRWText }}
                            </p>
                            <p class="font-bold text-sm text-accent-beige" v-if="settlementTWDText">
                                {{ settlementTWDText }}
                            </p>
                            <p v-if="!settlementKRWText && !settlementTWDText" class="text-sm opacity-80">
                                目前兩不相欠！
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                    <div class="flex gap-2 mb-3">
                        <button 
                            @click="newExpense.payer = 'Wawa'"
                            class="flex-1 py-2 rounded-lg text-xs font-bold border transition-all flex items-center justify-center gap-1"
                            :class="newExpense.payer === 'Wawa' ? 'bg-soft-brown text-white border-soft-brown' : 'bg-white text-gray-400 border-gray-200'"
                        >
                            <i class="ph-fill ph-user"></i> Wawa 付款
                        </button>
                        <button 
                            @click="newExpense.payer = 'Cherisa'"
                            class="flex-1 py-2 rounded-lg text-xs font-bold border transition-all flex items-center justify-center gap-1"
                            :class="newExpense.payer === 'Cherisa' ? 'bg-soft-brown text-white border-soft-brown' : 'bg-white text-gray-400 border-gray-200'"
                        >
                            <i class="ph-fill ph-user"></i> Cherisa 付款
                        </button>
                    </div>

                    <div class="grid grid-cols-12 gap-2 mb-2">
                        <input v-model="newExpense.item" class="col-span-5 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white focus:ring-1 ring-soft-brown" placeholder="項目">
                        
                        <input v-model.number="newExpense.amount" type="number" class="col-span-4 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white focus:ring-1 ring-soft-brown" placeholder="金額">

                        <div class="col-span-3 flex bg-gray-100 rounded-lg p-1">
                            <button 
                                @click="newExpense.currency = 'KRW'" 
                                class="flex-1 text-xs font-bold rounded transition-all flex items-center justify-center" 
                                :class="newExpense.currency === 'KRW' ? 'bg-white shadow text-soft-brown' : 'text-gray-400'"
                            >₩</button>
                            <button 
                                @click="newExpense.currency = 'TWD'" 
                                class="flex-1 text-xs font-bold rounded transition-all flex items-center justify-center" 
                                :class="newExpense.currency === 'TWD' ? 'bg-white shadow text-soft-brown' : 'text-gray-400'"
                            >NT</button>
                        </div>
                    </div>
                    <button @click="addExpense" class="w-full bg-accent-beige text-soft-brown font-bold py-2 rounded-lg text-sm hover:bg-[#ebdcc0] transition-colors">
                        新增支出
                    </button>
                </div>

                <div class="space-y-3 pb-10">
                    <div v-for="(exp, index) in data.expenses" :key="index" class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-50 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shrink-0"
                                 :class="exp.payer === 'Wawa' ? 'bg-indigo-300' : 'bg-rose-300'">
                                {{ exp.payer ? exp.payer[0] : '?' }}
                            </div>
                            <div>
                                <span class="text-gray-700 font-bold block">{{ exp.item }}</span>
                                <span class="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">
                                    {{ exp.payer }} 付款
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-soft-brown">
                                {{ exp.currency === 'TWD' ? 'NT$' : '₩' }} {{ exp.amount.toLocaleString() }}
                            </span>
                            <button @click="removeExpense(index)" class="text-gray-300 text-xs hover:text-red-400 p-1">
                                <i class="ph-fill ph-x-circle text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Modal 區域 -->
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeModal"></div>
                <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10 shadow-2xl overflow-y-auto max-h-[90vh]">
                    <h3 class="text-xl font-bold text-soft-brown mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">標題</label>
                            <input v-model="editingEvent.title" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 outline-none focus:border-soft-brown" placeholder="要去哪裡？">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-gray-500 ml-1">時間</label>
                                <input v-model="editingEvent.time" type="time" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 outline-none focus:border-soft-brown">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 ml-1">地點名稱 (顯示用)</label>
                                <input v-model="editingEvent.location" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 outline-none focus:border-soft-brown" placeholder="例如：首爾塔">
                            </div>
                        </div>
                        <!-- 新增 Map URL 輸入框 -->
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">地圖網址 (Google/Naver Map)</label>
                            <div class="relative">
                                <i class="ph-bold ph-map-trifold absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input v-model="editingEvent.mapUrl" class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-9 pr-3 py-2 outline-none focus:border-soft-brown text-sm" placeholder="貼上地圖連結 (選填)">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">照片</label>
                            <div @click="triggerFileUpload" class="w-full h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 overflow-hidden relative group">
                                <img v-if="editingEvent.image" :src="editingEvent.image" class="w-full h-full object-cover">
                                <div v-else class="text-center text-gray-400">
                                    <i class="ph-fill ph-camera text-2xl mb-1"></i>
                                    <span class="text-xs block">點擊上傳圖片</span>
                                </div>
                                <button v-if="editingEvent.image" @click.stop="removeImage" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1 hover:bg-black/70 z-10">
                                    <i class="ph-bold ph-x"></i>
                                </button>
                            </div>
                            <input type="file" ref="fileInput" @change="handleFileChange" accept="image/*" class="hidden">
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">相關連結 (網頁/IG/App)</label>
                            <div class="relative">
                                <i class="ph-bold ph-link absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input v-model="editingEvent.link" class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-9 pr-3 py-2 outline-none focus:border-soft-brown text-sm" placeholder="例如：IG貼文連結、部落格網址...">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">描述/備註</label>
                            <textarea v-model="editingEvent.desc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 outline-none focus:border-soft-brown text-sm" placeholder="詳細內容..."></textarea>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">重點提示 (紅底)</label>
                            <input v-model="editingEvent.note" class="w-full bg-red-50 border border-red-100 rounded-xl px-3 py-2 outline-none focus:border-alert-red text-alert-red placeholder-red-300" placeholder="例如：需付訂金">
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button v-if="isEditing" @click="deleteEvent" class="flex-1 py-3 rounded-xl border border-red-200 text-red-400 font-bold text-sm hover:bg-red-50">刪除</button>
                        <button @click="saveEvent" class="flex-[2] py-3 rounded-xl bg-soft-brown text-white font-bold text-sm shadow-lg shadow-soft-brown/30">儲存</button>
                    </div>
                    
                    <button @click="closeModal" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="zoomedImage" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md" @click="closeZoomModal">
                <img :src="zoomedImage" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl cursor-default" @click.stop>
                <button @click="closeZoomModal" class="absolute top-6 right-6 text-white/70 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors">
                    <i class="ph-bold ph-x text-2xl"></i>
                </button>
            </div>
        </transition>

        <div v-if="showToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50 fade-in">
            已複製到剪貼簿！
        </div>

    </div>

    <!-- Firebase 與 Vue 核心程式碼 -->
    <script type="module">
        import { createApp, reactive, toRefs, computed, onMounted, ref, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAVExpDtx81JdHHtWgMyMaa-lp00IYcBkA",
          authDomain: "seoul-9f211.firebaseapp.com",
          projectId: "seoul-9f211",
          storageBucket: "seoul-9f211.firebasestorage.app",
          messagingSenderId: "309977061052",
          appId: "1:309977061052:web:053e7b7e6da1177b7de2b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 預設清單項目
        const defaultChecklistItems = [
            // 衣物穿搭
            { text: '衣褲', category: '衣物穿搭' },
            { text: '外套', category: '衣物穿搭' },
            { text: '圍巾(冬天)', category: '衣物穿搭' },
            { text: '泳衣(海邊/泳池)', category: '衣物穿搭' },
            { text: '內衣內褲', category: '衣物穿搭' },
            { text: '運動服', category: '衣物穿搭' },
            { text: '襪子', category: '衣物穿搭' },
            { text: '睡衣', category: '衣物穿搭' },
            { text: '拖鞋', category: '衣物穿搭' },
            { text: '鞋子', category: '衣物穿搭' },
            { text: '帽子', category: '衣物穿搭' },
            { text: '墨鏡', category: '衣物穿搭' },
            { text: '眼鏡', category: '衣物穿搭' },
            // 盥洗美妝
            { text: '電棒', category: '盥洗美妝' },
            { text: '髮蠟', category: '盥洗美妝' },
            { text: '梳子', category: '盥洗美妝' },
            { text: '夾子', category: '盥洗美妝' },
            { text: '牙刷牙膏', category: '盥洗美妝' },
            { text: '面膜', category: '盥洗美妝' },
            { text: '洗面乳', category: '盥洗美妝' },
            { text: '化妝品', category: '盥洗美妝' },
            { text: '卸妝油', category: '盥洗美妝' },
            { text: '洗髮精', category: '盥洗美妝' },
            { text: '護髮素', category: '盥洗美妝' },
            { text: '沐浴乳', category: '盥洗美妝' },
            { text: '防曬乳液', category: '盥洗美妝' },
            { text: '濕紙巾', category: '盥洗美妝' },
            // 證件雜物
            { text: '簽證', category: '證件雜物' },
            { text: '傘', category: '證件雜物' },
            { text: '旅行袋', category: '證件雜物' },
            { text: '雨衣', category: '證件雜物' },
            { text: '髒衣袋', category: '證件雜物' },
            { text: '腳吊床', category: '證件雜物' },
            { text: '小毯子', category: '證件雜物' },
            { text: '頸枕', category: '證件雜物' },
            { text: '泡麵', category: '證件雜物' },
            // 電子設備
            { text: '行動電源', category: '電子設備' },
            { text: '轉接頭', category: '電子設備' },
            { text: '變壓器', category: '電子設備' },
            { text: '充電器', category: '電子設備' },
            { text: '網卡(eSIM )', category: '電子設備' },
            // 常備藥品
            { text: '腸胃藥', category: '常備藥品' },
            { text: '頭痛藥', category: '常備藥品' },
            { text: '暈車藥', category: '常備藥品' },
            { text: '鼻炎藥', category: '常備藥品' },
            { text: '止瀉藥', category: '常備藥品' },
        ];

        createApp({
            setup() {
                const fileInput = ref(null);
                const eventListRef = ref(null); 
                let sortableInstance = null;

                const state = reactive({
                    currentTab: 'schedule',
                    currentDayIndex: 0,
                    showToast: false,
                    showModal: false,
                    isEditing: false,
                    editingIndex: -1,
                    zoomedImage: null,
                    newItem: '',
                    newChecklistItem: '', // 新增 Checklist 輸入
                    currentShopper: 'Wawa',
                    newExpense: { item: '', amount: null, payer: 'Wawa', currency: 'KRW' },
                    data: {
                        shoppingList: [],
                        expenses: [],
                        checklist: [], // 新增 Checklist 資料
                        itinerary: [
                            { date: '12/27 (六)', weather: 'cloudy', temp: '6° / -3°', events: [] },
                            { date: '12/28 (日)', weather: 'sunny', temp: '6° / -4°', events: [] },
                            { date: '12/29 (一)', weather: 'cloudy', temp: '5° / -2°', events: [] },
                            { date: '12/30 (二)', weather: 'sunny', temp: '6° / -2°', events: [] },
                            { date: '12/31 (三)', weather: 'cloudy', temp: '5° / -8°', events: [] },
                            { date: '01/01 (四)', weather: 'sunny', temp: '-1° / -8°', events: [] },
                            { date: '01/02 (五)', weather: 'sunny', temp: '-1° / -8°', events: [] }
                        ]
                    }
                });

                // 新增 mapUrl 欄位
                const editingEvent = reactive({ title: '', time: '', location: '', mapUrl: '', desc: '', note: '', image: null, link: '' });
                
                const tabs = [
                    { id: 'schedule', name: '行程', icon: 'ph-fill ph-calendar-check' },
                    { id: 'info', name: '資訊', icon: 'ph-fill ph-info' },
                    { id: 'checklist', name: '準備', icon: 'ph-fill ph-suitcase' }, // 新增 Tab
                    { id: 'shopping', name: '清單', icon: 'ph-fill ph-shopping-bag' },
                    { id: 'money', name: '花費', icon: 'ph-fill ph-coins' },
                ];
                const weatherTypes = ['sunny', 'cloudy', 'rain', 'snow'];

                // 初始化 Checklist (從 Local Storage 讀取)
                const initChecklist = () => {
                    const localData = localStorage.getItem('seoul_trip_checklist');
                    if (localData) {
                        try {
                            state.data.checklist = JSON.parse(localData);
                        } catch(e) {
                            console.error('Checklist parse error', e);
                            loadDefaultChecklist();
                        }
                    } else {
                        // 如果 Local Storage 是空的，載入預設值
                        loadDefaultChecklist();
                    }
                };

                const loadDefaultChecklist = () => {
                    state.data.checklist = defaultChecklistItems.map((item, index) => ({
                        id: index,
                        text: item.text,
                        category: item.category,
                        checked: false,
                        isCustom: false
                    }));
                    saveChecklistToLocal();
                };

                // 將 Checklist 儲存到 Local Storage (不存 Firebase)
                const saveChecklistToLocal = () => {
                    localStorage.setItem('seoul_trip_checklist', JSON.stringify(state.data.checklist));
                };

                const initSortable = () => {
                    if (sortableInstance) sortableInstance.destroy();
                    if (eventListRef.value) {
                        sortableInstance = new Sortable(eventListRef.value, {
                            animation: 150,
                            delay: 200, 
                            delayOnTouchOnly: true, 
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => {
                                const item = state.data.itinerary[state.currentDayIndex].events.splice(evt.oldIndex, 1)[0];
                                state.data.itinerary[state.currentDayIndex].events.splice(evt.newIndex, 0, item);
                                saveToFirebase();
                            }
                        });
                    }
                };

                watch(
                    [() => state.currentTab, () => state.currentDayIndex, () => state.data.itinerary],
                    async () => {
                        if (state.currentTab === 'schedule') {
                            await nextTick(); 
                            initSortable();
                        }
                    },
                    { deep: true } 
                );

                onMounted(() => {
                    // 1. 先載入本地 Checklist
                    initChecklist();

                    // 2. 監聽 Firebase 資料
                    const docRef = doc(db, "trips", "seoul");
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const remoteData = docSnap.data();
                            
                            // 關鍵修改：只同步 checklist 以外的資料
                            // 這樣伺服器回傳的資料就不會覆蓋本地的 checklist
                            const { checklist, ...syncedData } = remoteData;
                            
                            state.data = {
                                ...state.data,
                                ...syncedData
                            };
                            
                            // 如果 Firebase 遺漏了某些欄位 (例如初次建立)，確保結構完整
                            if(!state.data.itinerary) state.data.itinerary = [];
                            if(!state.data.shoppingList) state.data.shoppingList = [];
                            if(!state.data.expenses) state.data.expenses = [];

                        } else {
                            // 文件不存在，初始化並存入 (不含 checklist)
                            saveToFirebase();
                        }
                    });
                });

                const saveToFirebase = async () => {
                    try {
                        // 關鍵修改：複製資料並移除 checklist，避免存入 Firebase
                        const dataToSave = JSON.parse(JSON.stringify(state.data));
                        delete dataToSave.checklist; 
                        
                        await setDoc(doc(db, "trips", "seoul"), dataToSave);
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                };

                // Checklist 相關功能
                const categorizedChecklist = computed(() => {
                    const groups = {
                        '衣物穿搭': [],
                        '盥洗美妝': [],
                        '電子設備': [],
                        '證件雜物': [],
                        '常備藥品': [],
                        '自訂/其他': []
                    };
                    
                    if (state.data.checklist) {
                        state.data.checklist.forEach(item => {
                            if (groups[item.category]) {
                                groups[item.category].push(item);
                            } else {
                                groups['自訂/其他'].push(item);
                            }
                        });
                    }

                    // 移除空的分類
                    Object.keys(groups).forEach(key => {
                        if (groups[key].length === 0) delete groups[key];
                    });
                    
                    return groups;
                });

                const progressPercentage = computed(() => {
                    if (!state.data.checklist || state.data.checklist.length === 0) return 0;
                    const checkedCount = state.data.checklist.filter(i => i.checked).length;
                    return Math.round((checkedCount / state.data.checklist.length) * 100);
                });

                const progressText = computed(() => {
                    if (!state.data.checklist || state.data.checklist.length === 0) return '0%';
                    const checkedCount = state.data.checklist.filter(i => i.checked).length;
                    return `${checkedCount} / ${state.data.checklist.length} (${progressPercentage.value}%)`;
                });

                const addChecklistItem = () => {
                    if (state.newChecklistItem.trim()) {
                        const newId = state.data.checklist.length > 0 ? Math.max(...state.data.checklist.map(i => i.id)) + 1 : 1;
                        state.data.checklist.push({
                            id: newId,
                            text: state.newChecklistItem.trim(),
                            category: '自訂/其他',
                            checked: false,
                            isCustom: true
                        });
                        state.newChecklistItem = '';
                        saveChecklistToLocal(); // 改為存入本地
                    }
                };

                const toggleChecklistItem = (item) => {
                    item.checked = !item.checked;
                    saveChecklistToLocal(); // 改為存入本地
                };

                const deleteChecklistItem = (item) => {
                    state.data.checklist = state.data.checklist.filter(i => i.id !== item.id);
                    saveChecklistToLocal(); // 改為存入本地
                };

                const totalKRW = computed(() => state.data.expenses.filter(e => e.currency === 'KRW').reduce((sum, item) => sum + item.amount, 0));
                const totalTWD = computed(() => state.data.expenses.filter(e => e.currency === 'TWD').reduce((sum, item) => sum + item.amount, 0));
                const wawaPaidKRW = computed(() => state.data.expenses.filter(e => e.payer === 'Wawa' && e.currency === 'KRW').reduce((sum, item) => sum + item.amount, 0));
                const wawaPaidTWD = computed(() => state.data.expenses.filter(e => e.payer === 'Wawa' && e.currency === 'TWD').reduce((sum, item) => sum + item.amount, 0));
                const cherisaPaidKRW = computed(() => state.data.expenses.filter(e => e.payer === 'Cherisa' && e.currency === 'KRW').reduce((sum, item) => sum + item.amount, 0));
                const cherisaPaidTWD = computed(() => state.data.expenses.filter(e => e.payer === 'Cherisa' && e.currency === 'TWD').reduce((sum, item) => sum + item.amount, 0));

                const settlementKRWText = computed(() => {
                    const diff = wawaPaidKRW.value - cherisaPaidKRW.value;
                    const halfDiff = Math.abs(diff) / 2;
                    if (Math.round(halfDiff) === 0) return null;
                    return diff > 0 ? `Cherisa 給 Wawa ₩ ${Math.round(halfDiff).toLocaleString()}` : `Wawa 給 Cherisa ₩ ${Math.round(halfDiff).toLocaleString()}`;
                });

                const settlementTWDText = computed(() => {
                    const diff = wawaPaidTWD.value - cherisaPaidTWD.value;
                    const halfDiff = Math.abs(diff) / 2;
                    if (Math.round(halfDiff) === 0) return null;
                    return diff > 0 ? `Cherisa 給 Wawa NT$ ${Math.round(halfDiff).toLocaleString()}` : `Wawa 給 Cherisa NT$ ${Math.round(halfDiff).toLocaleString()}`;
                });

                const currentDayData = computed(() => state.data.itinerary[state.currentDayIndex]);
                const filteredShoppingList = computed(() => state.data.shoppingList.filter(item => item.owner === state.currentShopper));

                const triggerFileUpload = () => {
                    if (fileInput.value) fileInput.value.click();
                };

                const openZoomModal = (img) => state.zoomedImage = img;
                const closeZoomModal = () => state.zoomedImage = null;

                const addExpense = () => {
                    if (state.newExpense.item && state.newExpense.amount) {
                        state.data.expenses.push({ ...state.newExpense });
                        saveToFirebase();
                        state.newExpense.item = '';
                        state.newExpense.amount = null;
                    }
                };
                
                const removeExpense = (index) => {
                    state.data.expenses.splice(index, 1);
                    saveToFirebase();
                };

                const addItem = () => {
                    if (state.newItem.trim()) {
                        state.data.shoppingList.push({
                            id: Date.now(),
                            text: state.newItem,
                            done: false,
                            owner: state.currentShopper
                        });
                        state.newItem = '';
                        saveToFirebase();
                    }
                };

                const deleteItem = (itemToDelete) => {
                    state.data.shoppingList = state.data.shoppingList.filter(item => item.id !== itemToDelete.id);
                    saveToFirebase();
                };
                
                const toggleItemDone = (item) => {
                    item.done = !item.done;
                    saveToFirebase();
                };

                const cycleWeather = (dayIndex) => {
                    const current = state.data.itinerary[dayIndex].weather;
                    const idx = weatherTypes.indexOf(current);
                    const nextIdx = (idx + 1) % weatherTypes.length;
                    state.data.itinerary[dayIndex].weather = weatherTypes[nextIdx];
                    saveToFirebase();
                };

                const openAddModal = () => {
                    state.isEditing = false;
                    Object.assign(editingEvent, { title: '', time: '', location: '', mapUrl: '', desc: '', note: '', image: null, link: '' });
                    state.showModal = true;
                };

                const openEditModal = (index) => {
                    state.isEditing = true;
                    state.editingIndex = index;
                    Object.assign(editingEvent, JSON.parse(JSON.stringify(currentDayData.value.events[index])));
                    state.showModal = true;
                };

                const closeModal = () => state.showModal = false;

                const saveEvent = () => {
                    if (!editingEvent.title) return;
                    if (state.isEditing) {
                        state.data.itinerary[state.currentDayIndex].events[state.editingIndex] = { ...editingEvent };
                    } else {
                        state.data.itinerary[state.currentDayIndex].events.push({ ...editingEvent });
                    }
                    saveToFirebase();
                    closeModal();
                };

                const deleteEvent = () => {
                    if (confirm('確定刪除？')) {
                        state.data.itinerary[state.currentDayIndex].events.splice(state.editingIndex, 1);
                        saveToFirebase();
                        closeModal();
                    }
                };

                const handleFileChange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        if(file.size > 500000) alert("提醒：圖片過大可能會導致同步失敗，建議使用小圖截圖");
                        const reader = new FileReader();
                        reader.onload = (e) => editingEvent.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                
                const removeImage = () => editingEvent.image = null;
                const getNaverLink = (q) => `https://map.naver.com/v5/search/${encodeURIComponent(q)}`;
                const getWeatherIcon = (t) => ({'sunny': 'ph-fill ph-sun text-amber-400', 'cloudy': 'ph-fill ph-cloud text-gray-400', 'rain': 'ph-fill ph-cloud-rain text-blue-400', 'snow': 'ph-fill ph-snowflake text-sky-300'}[t] || 'ph-fill ph-sun');
                const getWeatherName = (t) => ({'sunny': '晴天', 'cloudy': '多雲', 'rain': '下雨', 'snow': '下雪'}[t]);
                const copyText = (t) => {
                    navigator.clipboard.writeText(t).then(() => {
                        state.showToast = true;
                        setTimeout(() => state.showToast = false, 2000);
                    });
                };
                const handleImageError = (e) => e.target.src = 'https://images.unsplash.com/photo-1538485399081-7191377e8241?q=80&w=1920&auto=format&fit=crop';

                return {
                    ...toRefs(state),
                    fileInput, triggerFileUpload, eventListRef,
                    tabs, editingEvent,
                    totalKRW, totalTWD, wawaPaidKRW, wawaPaidTWD, cherisaPaidKRW, cherisaPaidTWD,
                    settlementKRWText, settlementTWDText, currentDayData, filteredShoppingList, categorizedChecklist,
                    progressPercentage, progressText,
                    openZoomModal, closeZoomModal,
                    addExpense, removeExpense, addItem, deleteItem, toggleItemDone,
                    addChecklistItem, toggleChecklistItem, deleteChecklistItem,
                    cycleWeather, openAddModal, openEditModal, closeModal, saveEvent, deleteEvent,
                    handleFileChange, removeImage, getNaverLink, getWeatherIcon, getWeatherName, copyText, handleImageError
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

