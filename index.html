    <script type="module">
        // 1. 這裡補上了 ref
        import { createApp, reactive, toRefs, computed, onMounted, ref } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 您的 Firebase 設定
        const firebaseConfig = {
          apiKey: "AIzaSyAVExpDtx81JdHHtWgMyMaa-lp00IYcBkA",
          authDomain: "seoul-9f211.firebaseapp.com",
          projectId: "seoul-9f211",
          storageBucket: "seoul-9f211.firebasestorage.app",
          messagingSenderId: "309977061052",
          appId: "1:309977061052:web:053e7b7e6da1177b7de2b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                // 2. 定義 fileInput ref，用來對應 HTML 中的 ref="fileInput"
                const fileInput = ref(null);

                const state = reactive({
                    currentTab: 'schedule',
                    currentDayIndex: 0,
                    headerImage: './image.png',
                    showToast: false,
                    showModal: false,
                    isEditing: false,
                    editingIndex: -1,
                    zoomedImage: null,
                    
                    newItem: '',
                    currentShopper: 'Wawa',
                    newExpense: { item: '', amount: null, payer: 'Wawa', currency: 'KRW' },
                    
                    data: {
                        shoppingList: [],
                        expenses: [],
                        itinerary: [
                            { date: '12/27 (六)', weather: 'cloudy', temp: '6° / -3°', events: [] },
                            { date: '12/28 (日)', weather: 'sunny', temp: '6° / -4°', events: [] },
                            { date: '12/29 (一)', weather: 'cloudy', temp: '5° / -2°', events: [] },
                            { date: '12/30 (二)', weather: 'sunny', temp: '6° / -2°', events: [] },
                            { date: '12/31 (三)', weather: 'cloudy', temp: '5° / -8°', events: [] },
                            { date: '01/01 (四)', weather: 'sunny', temp: '-1° / -8°', events: [] },
                            { date: '01/02 (五)', weather: 'sunny', temp: '-1° / -8°', events: [] }
                        ]
                    }
                });

                const editingEvent = reactive({ title: '', time: '', location: '', desc: '', note: '', image: null, link: '' });
                
                const tabs = [
                    { id: 'schedule', name: '行程', icon: 'ph-fill ph-calendar-check' },
                    { id: 'info', name: '資訊', icon: 'ph-fill ph-info' },
                    { id: 'shopping', name: '清單', icon: 'ph-fill ph-shopping-bag' },
                    { id: 'money', name: '花費', icon: 'ph-fill ph-coins' },
                ];
                const weatherTypes = ['sunny', 'cloudy', 'rain', 'snow'];

                onMounted(() => {
                    const docRef = doc(db, "trips", "seoul");
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const remoteData = docSnap.data();
                            state.data = { ...state.data, ...remoteData };
                        } else {
                            saveToFirebase();
                        }
                    });
                });

                const saveToFirebase = async () => {
                    try {
                        await setDoc(doc(db, "trips", "seoul"), JSON.parse(JSON.stringify(state.data)));
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        alert("儲存失敗，請檢查網路！");
                    }
                };

                const totalKRW = computed(() => state.data.expenses.filter(e => e.currency === 'KRW').reduce((sum, item) => sum + item.amount, 0));
                const totalTWD = computed(() => state.data.expenses.filter(e => e.currency === 'TWD').reduce((sum, item) => sum + item.amount, 0));
                
                const wawaPaidKRW = computed(() => state.data.expenses.filter(e => e.payer === 'Wawa' && e.currency === 'KRW').reduce((sum, item) => sum + item.amount, 0));
                const wawaPaidTWD = computed(() => state.data.expenses.filter(e => e.payer === 'Wawa' && e.currency === 'TWD').reduce((sum, item) => sum + item.amount, 0));
                
                const cherisaPaidKRW = computed(() => state.data.expenses.filter(e => e.payer === 'Cherisa' && e.currency === 'KRW').reduce((sum, item) => sum + item.amount, 0));
                const cherisaPaidTWD = computed(() => state.data.expenses.filter(e => e.payer === 'Cherisa' && e.currency === 'TWD').reduce((sum, item) => sum + item.amount, 0));

                const settlementKRWText = computed(() => {
                    const diff = wawaPaidKRW.value - cherisaPaidKRW.value;
                    const halfDiff = Math.abs(diff) / 2;
                    if (Math.round(halfDiff) === 0) return null;
                    return diff > 0 ? `Cherisa 給 Wawa ₩ ${Math.round(halfDiff).toLocaleString()}` : `Wawa 給 Cherisa ₩ ${Math.round(halfDiff).toLocaleString()}`;
                });

                const settlementTWDText = computed(() => {
                    const diff = wawaPaidTWD.value - cherisaPaidTWD.value;
                    const halfDiff = Math.abs(diff) / 2;
                    if (Math.round(halfDiff) === 0) return null;
                    return diff > 0 ? `Cherisa 給 Wawa NT$ ${Math.round(halfDiff).toLocaleString()}` : `Wawa 給 Cherisa NT$ ${Math.round(halfDiff).toLocaleString()}`;
                });

                const currentDayData = computed(() => state.data.itinerary[state.currentDayIndex]);
                const filteredShoppingList = computed(() => state.data.shoppingList.filter(item => item.owner === state.currentShopper));

                const triggerBannerUpload = () => document.querySelector('input[type=file]').click();
                
                // 3. 定義觸發上傳的函式
                const triggerFileUpload = () => {
                    if (fileInput.value) {
                        fileInput.value.click();
                    }
                };
                
                const handleBannerChange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => state.headerImage = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };

                const openZoomModal = (img) => state.zoomedImage = img;
                const closeZoomModal = () => state.zoomedImage = null;

                const addExpense = () => {
                    if (state.newExpense.item && state.newExpense.amount) {
                        state.data.expenses.push({ ...state.newExpense });
                        saveToFirebase();
                        state.newExpense.item = '';
                        state.newExpense.amount = null;
                    }
                };
                
                const removeExpense = (index) => {
                    state.data.expenses.splice(index, 1);
                    saveToFirebase();
                };

                const addItem = () => {
                    if (state.newItem.trim()) {
                        state.data.shoppingList.push({
                            id: Date.now(),
                            text: state.newItem,
                            done: false,
                            owner: state.currentShopper
                        });
                        state.newItem = '';
                        saveToFirebase();
                    }
                };

                const deleteItem = (itemToDelete) => {
                    state.data.shoppingList = state.data.shoppingList.filter(item => item.id !== itemToDelete.id);
                    saveToFirebase();
                };
                
                const toggleItemDone = (item) => {
                    item.done = !item.done;
                    saveToFirebase();
                };

                const cycleWeather = (dayIndex) => {
                    const current = state.data.itinerary[dayIndex].weather;
                    const idx = weatherTypes.indexOf(current);
                    const nextIdx = (idx + 1) % weatherTypes.length;
                    state.data.itinerary[dayIndex].weather = weatherTypes[nextIdx];
                    saveToFirebase();
                };

                const openAddModal = () => {
                    state.isEditing = false;
                    Object.assign(editingEvent, { title: '', time: '', location: '', desc: '', note: '', image: null, link: '' });
                    state.showModal = true;
                };

                const openEditModal = (index) => {
                    state.isEditing = true;
                    state.editingIndex = index;
                    Object.assign(editingEvent, JSON.parse(JSON.stringify(currentDayData.value.events[index])));
                    state.showModal = true;
                };

                const closeModal = () => state.showModal = false;

                const saveEvent = () => {
                    if (!editingEvent.title) return;
                    if (state.isEditing) {
                        state.data.itinerary[state.currentDayIndex].events[state.editingIndex] = { ...editingEvent };
                    } else {
                        state.data.itinerary[state.currentDayIndex].events.push({ ...editingEvent });
                        state.data.itinerary[state.currentDayIndex].events.sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                    }
                    saveToFirebase();
                    closeModal();
                };

                const deleteEvent = () => {
                    if (confirm('確定刪除？')) {
                        state.data.itinerary[state.currentDayIndex].events.splice(state.editingIndex, 1);
                        saveToFirebase();
                        closeModal();
                    }
                };

                const handleFileChange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        if(file.size > 500000) alert("提醒：圖片過大可能會導致同步失敗，建議使用小圖截圖");
                        const reader = new FileReader();
                        reader.onload = (e) => editingEvent.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                
                const removeImage = () => editingEvent.image = null;
                const getNaverLink = (q) => `https://map.naver.com/v5/search/${encodeURIComponent(q)}`;
                const getWeatherIcon = (t) => ({'sunny': 'ph-fill ph-sun text-amber-400', 'cloudy': 'ph-fill ph-cloud text-gray-400', 'rain': 'ph-fill ph-cloud-rain text-blue-400', 'snow': 'ph-fill ph-snowflake text-sky-300'}[t] || 'ph-fill ph-sun');
                const getWeatherName = (t) => ({'sunny': '晴天', 'cloudy': '多雲', 'rain': '下雨', 'snow': '下雪'}[t]);
                const copyText = (t) => {
                    navigator.clipboard.writeText(t).then(() => {
                        state.showToast = true;
                        setTimeout(() => state.showToast = false, 2000);
                    });
                };
                const handleImageError = (e) => e.target.src = 'https://images.unsplash.com/photo-1538485399081-7191377e8241?q=80&w=1920&auto=format&fit=crop';

                return {
                    ...toRefs(state),
                    tabs, editingEvent,
                    // 4. 將 fileInput 和 triggerFileUpload 回傳給模板使用
                    fileInput, triggerFileUpload,
                    totalKRW, totalTWD, wawaPaidKRW, wawaPaidTWD, cherisaPaidKRW, cherisaPaidTWD,
                    settlementKRWText, settlementTWDText, currentDayData, filteredShoppingList,
                    triggerBannerUpload, handleBannerChange, openZoomModal, closeZoomModal,
                    addExpense, removeExpense, addItem, deleteItem, toggleItemDone,
                    cycleWeather, openAddModal, openEditModal, closeModal, saveEvent, deleteEvent,
                    handleFileChange, removeImage, getNaverLink, getWeatherIcon, getWeatherName, copyText, handleImageError
                };
            }
        }).mount('#app');
    </script>
